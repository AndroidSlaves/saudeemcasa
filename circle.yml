#
# Build configuration for Circle CI
#

general:
    artifacts:
        - /home/ubuntu/saudeemcasa/app/build/outputs/apk/

machine:
    environment:
        ANDROID_HOME: /usr/local/android-sdk-linux

dependencies:
    override:
        - echo y | android update sdk --no-ui --all --filter tools,platform-tools,build-tools-21.1.2,android-21,extra-google-m2repository,extra-google-google_play_services,extra-android-support
        - ANDROID_HOME=/usr/local/android-sdk-linux ./gradlew dependencies

test:
    override:
  
  # perform unit tests
  - ./gradlew tesMockDebugUnitTest
  # Save test reports
  - mkdir -p $CIRCLE_TEST_REPORTS/reports/unit-tests
  - cp -avr app/build/reports/tests/mockDebug/ $CIRCLE_TEST_REPORTS/reports/unit-tests
  - mkdir -p $CIRCLE_TEST_REPORTS/junit/
  - find . -type f -regex ".*/build/test-results/mockDebug/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

  # start the emulator
  - emulator -avd circleci-android22 -no-audio -no-window:
      background: true
      parallel: true
  # wait for it to have booted
  - circle-android wait-for-boot
  # unlock the emulator screen
  - sleep 30
  - adb shell input keyevent 82
  # run tests against the emulator.
  - ./gradlew connectedMockDebugAndroidTest -PdisablePreDex
  # Copying the test reports
  - mkdir -p $CIRCLE_TEST_REPORTS/reports/functional-tests
  - cp -avr app/build/reports/androidTests/connected/flavors/MOCK/ $CIRCLE_TEST_REPORTS/reports/functional-tests
       # - (./gradlew assemble):
        #    timeout: 360